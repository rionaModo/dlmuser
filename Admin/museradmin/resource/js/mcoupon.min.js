function showNoChance(){popup("抱歉，您已经没机会！")}function initLucky(){function t(t,i){var o=0==i?!1:!0;$.get("/router/activity/chance",{activityId:t,companyId:userInfo.companyId,t:Date.now()},function(i){var i=JSON.parse(i);return i.status?(_paq.push(["trackEvent","mobile_lucky","getchance_error",t]),e("btn_gray","机会已用完"),void(o&&n(1))):i.data.ticketStock<1?(l=!0,e("btn_gray","机会已用完"),_paq.push(["trackEvent","mobile_lucky","enter_nochance",t]),void(o&&n())):($("#lucky-time-bar").replaceWith('<div class="coming-soon">抢红包活动进行中！</div>'),$(".lucky-activity .coming-soon").html("抢红包活动进行中!"),e("btn_rob"),$(".lucky-activity").find(".rob-tag").addClass("luckother-btn"),r(),void(o&&n(2)))})}function n(n){c?1==n?(e("btn_coming",""),noWactivityId=c.activityId,c.startLeft<0?($("#lucky-time-bar").replaceWith('<div class="coming-soon">抢红包活动进行中！</div>'),$(".lucky-activity .coming-soon").html("抢红包活动进行中!"),t(noWactivityId,!1)):o(c.startLeft,function(){$("#lucky-time-bar").replaceWith('<div class="coming-soon">抢红包活动进行中！</div>'),$(".lucky-activity .coming-soon").html("抢红包活动进行中!"),t(noWactivityId,!1)})):2!=n&&o(c.startLeft):(2!=n&&($("#lucky-time-bar").replaceWith('<div class="coming-soon">下波活动敬请期待!</div>'),$(".lucky-activity .coming-soon").html("下波活动敬请期待!")),_paq.push(["trackEvent","mobile_lucky","no_next_lucky"]))}function e(t,n){$("#lucky-action-btn").removeClass("btn_rob btn_out btn_end btn_gray btn_coming").addClass(t),$("#lucky-action-btn").html(n?n:"")}function i(){function t(e,i,a){return i.find(".showTime").html(e),e--,0==e||rollTime-e>=6?void(n=setTimeout(function(){layer.close(a),clearTimeout(n),o()},1e3)):void(n=setTimeout(function(){t(e,i,a)},1e3))}if(l)return showLayer(getLayerContent("luckNoChance","您的本轮抢红包机会已用完，下轮继续！")),e("btn_gray","机会已用完");var n,i=!1,o=function(){$(".lucky-activity .coming-soon").html("抢红包活动进行中！"),showLayer(getLayerContent("more_one","<p>今天抢红包的小伙伴太多了。</p><p>再抢一次吧</p>"),function(t){t.find(".close").html("再抢一次")})};showLayer(getLayerContent("luck_money","<p class='rob_my_minutes'><span class='showTime'>"+rollTime+"</span></p><p class='rob_my_tip'>抢红包了，排队中！</p><p class='rob_my_time'> (千万别关掉我)</p>",!0),function(n,e){t(rollTime,n,e)}),_paq.push(["trackEvent","mobile_lucky","roll_click",a.activityId]),s||(s=!0,$.get("/router/activity/roll",{activityId:noWactivityId,companyId:userInfo.companyId,t:Date.now()},function(t){var t=JSON.parse(t);return i=!0,s=!1,403==t.status&&location.reload(),1==t.status?void(o=function(){e("btn_gray","机会已用完"),l=!0,i=!0,_paq.push(["trackEvent","mobile_lucky","rolled_no_chance",a.activityId]),showLayer(getLayerContent("luckNoChance","您的本轮抢红包机会已用完，下轮继续！"),function(t){t.find(".close").click(function(){location.reload()}),t.find(".left-close").click(function(){location.reload()})}),$(".lucky-activity .coming-soon").html("下波活动敬请期待！"),$(".lucky-activity").find(".rob-tag").removeClass("luckother-btn")}):4!=t.status&&5!=t.status?2==t.status||6==t.status?void(o=function(){e("btn_end"),_paq.push(["trackEvent","mobile_lucky","rolled_ended",a.activityId]),showLayer(getLayerContent("","活动已结束！"),function(t){t.find(".close").click(function(){location.reload()}),t.find(".left-close").click(function(){location.reload()})}),$(".lucky-activity .coming-soon").html("下波活动敬请期待！"),$(".lucky-activity").find(".rob-tag").removeClass("luckother-btn")}):3==t.status?void(o=function(){_paq.push(["trackEvent","mobile_lucky","rolled_system_error",a.activityId]),showLayer(getLayerContent("",t.msg)),$(".lucky-activity").find(".rob-tag").removeClass("luckother-btn"),$(".lucky-activity .coming-soon").html("下波活动敬请期待！")}):void(o=function(){var n=t.data;if(!n.tradingPrizeList)return _paq.push(["trackEvent","mobile_lucky","rolled_lucky_out",a.activityId]),showLayer(getLayerContent("rob_all","<p>抢红包的小伙伴们手太快啦！！ </p><p>下轮继续加油哦！</p>"),function(t){t.find(".close").click(function(){location.reload()}),t.find(".left-close").click(function(){location.reload()})}),e("btn_out"),void $(".lucky-activity").find(".rob-tag").removeClass("luckother-btn");n.remainTime<1&&(l=!0,e("btn_gray","机会已用完"),$(".lucky-activity").find(".rob-tag").removeClass("luckother-btn"),$(".lucky-activity .coming-soon").html("下波活动敬请期待！"));var i=n.tradingPrizeList[0];if(("10"==n.prizeLevel||"11"==n.prizeLevel)&&i.dealerCoupons.length>0)return void("11"==n.prizeLevel?showLayer(getLayerContent("additional_cop","<div class='additional_content'><div class='additional_cop_left clearfix'><p class='additional_title'>优惠券</p><p class='money-line'><span class='money-icon'>￥</span>"+i.couponAmt/100+"</p><p class='additional_ad'>满"+i.effectiveAmt/100+"可用</p></div><div class='additional_cop_right clearfix'><p class='additional-title'>可用范围：</p><p class='additional_shop'>"+i.dealerCoupons[0].dealerName+"</p><p class='additional_list'>可购买：  "+i.dealerCoupons[0].goodsName+"</p></div></div><p class='rob_my_tip'>恭喜您获得一张价值<span>"+i.couponAmt/100+"</span>元的红包！</p><p class='rob_my_time'> 红包将在10分钟内完成发放，请注意查看个人账户。</p>"),function(){}):showLayer(getLayerContent("additional_packet","<div class='additional_content'><div class='additional_cop_left clearfix'><p class='additional_title'>经销商红包</p><p class='money-line'><span class='money-icon'>￥</span>"+i.couponAmt/100+"</p><p class='additional_ad'>满"+i.effectiveAmt/100+"可用</p></div><div class='additional_cop_right clearfix'><p class='additional-title'>可用范围：</p><p class='additional_shop'>"+i.dealerCoupons[0].dealerName+"</p></div></div><p class='rob_my_tip'>恭喜您获得一张价值<span>"+i.couponAmt/100+"</span>元的红包！</p><p class='rob_my_time'> 红包将在10分钟内完成发放，请注意查看个人账户。</p>"),function(){}));var o=countCouponList(n.tradingPrizeList);_paq.push(["trackEvent","mobile_lucky","rolled_get_"+a.activityId,o]),o/=100,showLayer(getLayerContent("rob_money","<p class='rob_my_tip'>恭喜您获得一张价值<span>"+o+"</span>元的红包！</p><p class='rob_my_time'> 红包将在10分钟内完成发放，请注意查看个人账户。</p>",null,"<div class='money_show'>"+o+"元</div>"),function(t){n.remainTime<1&&(t.find(".close").click(function(){location.reload()}),t.find(".left-close").click(function(){location.reload()}))})}):void 0}))}function o(t,n){$("#lucky-time-bar").timebar(t,function(){n&&"function"==typeof n?n():($("#lucky-time-bar").replaceWith('<div class="coming-soon"><a href="">活动即将开始,点击刷新</a></div>'),$(".lucky-activity .coming-soon").html('<a href="">活动即将开始,点击刷新</a>')),_paq.push(["trackEvent","mobile_lucky","waited_start",c.activityId])})}var a=ACT_INFO.lucky.pre,c=ACT_INFO.lucky.next,l=!1,s=(Date.now(),!1);a?noWactivityId=a.activityId:"",$("#lucky-lights").flash("yellow blue green".split(" "));var r=function(){$(".lucky-activity").on("click",".btn_rob",i),$(".lucky-activity").on("click","luckother-btn",i)};if(a){if(a.startLeft>0)return o(a.startLeft,function(){$("#lucky-time-bar").replaceWith('<div class="coming-soon">抢红包活动进行中！</div>'),$(".lucky-activity .coming-soon").html("抢红包活动进行中！"),e("btn_rob"),$(".lucky-activity").find(".rob-tag").addClass("luckother-btn"),r()}),void e("btn_coming","");if(a.endLeft<0)e("btn_end"),_paq.push(["trackEvent","mobile_lucky","enter_ended",a.activityId]),n(1);else{if(1==a.status)return $("#lucky-time-bar").replaceWith('<div class="coming-soon"><a href="">活动即将开始,点击刷新</a></div>'),void $(".lucky-activity .coming-soon").html('<a href="">活动即将开始,点击刷新</a>');a.couponStock<1&&null!=a.additionalCouponStock&&a.additionalCouponStock<1||a.couponStock<1&&null==a.additionalCouponStock?(e("btn_out"),_paq.push(["trackEvent","mobile_lucky","enter_lucky_out",a.activityId]),n()):t(a.activityId)}}else e("btn_end"),_paq.push(["trackEvent","mobile_lucky","no_present_lucky"]),n(1)}function initLottery(){var t=function(){function t(t){var t=t||0;parseInt(t)<=0&&(t=0),d.$chanceLeft.html(t),1>t&&d.info.startLeft<1&&d.info.endLeft>0&&n("disable-nochance")}function n(t){d.$lotteryBtn.removeClass("active disable disable-canshowrule").addClass(t)}function e(t,n){0>t?$("#lottery-time-bar").hide():($("#lottery-time-bar").show(),$("#lottery-time-bar").timebar(t,n))}function i(){var t={radius:165,amount:30,fix:function(t){return t.left-=28,t.top-=29,t}},n=circleLamp(t),e=$("#lottery-lights").html(n).flash("yellow blue green purple".split(" "));return e}function o(){$.get("/router/activity/roll",{activityId:d.info.activityId,companyId:userInfo.companyId,t:Date.now()},function(e){function i(){if(t(o.remainTime),o.prizeLevel&&o.tradingPrizeList){var n=countCouponList(o.tradingPrizeList);n/=100,showLayer(getLayerContent("rob_money","<p class='rob_my_tip'>恭喜您获得一张价值<span>"+n+"</span>元的红包！</p><p class='rob_my_time'> 红包将在10分钟内完成发放，请注意查看个人账户。</p>",null,"<div class='money_show'>"+n+"元</div>"))}else showLayer(getLayerContent("","很遗憾，没有抽中。下次再接再厉！"));s=!1}if(e.status&&_paq.push(["trackEvent","mobile_lottery","rolled_system_error",d.info.activityId]),1==e.status)return n("disable"),showLayer(getLayerContent("noChance","<p>您未获得抽奖机会或已用完。下单越多，抽奖机会越多！ </p><p>（详见幸运轮盘详细规则）</p>")),_paq.push(["trackEvent","mobile_lottery","rolled_no_chance",d.info.activityId]),t(0);if(2==e.status)return n("disable"),_paq.push(["trackEvent","mobile_lottery","rolled_ended",d.info.activityId]),$(".lottery").find(".chance-left").text("本轮活动已结束"),void showLayer(getLayerContent("","活动已结束！"));if(3==e.status)return _paq.push(["trackEvent","mobile_lottery","rolled_status3",d.info.activityId]),layer.alert(e.msg);var o=e.data;if(o.tradingPrizeList&&o.tradingPrizeList[0]){var a=o.tradingPrizeList[0];if(("10"==o.prizeLevel||"11"==o.prizeLevel)&&a.dealerCoupons.length>0)return"11"==o.prizeLevel?showLayer(getLayerContent("additional_cop","<div class='additional_content'><div class='additional_cop_left clearfix'><p class='additional_title'>优惠券</p><p class='money-line'><span class='money-icon'>￥</span>"+a.couponAmt/100+"</p><p class='additional_ad'>满"+a.effectiveAmt/100+"可用</p></div><div class='additional_cop_right clearfix'><p class='additional-title'>可用范围：</p><p class='additional_shop'>"+a.dealerCoupons[0].dealerName+"</p><p class='additional_list'>可购买：  "+a.dealerCoupons[0].goodsName+"</p></div></div><p class='rob_my_tip'>恭喜您获得一张价值<span>"+a.couponAmt/100+"</span>元的红包！</p><p class='rob_my_time'> 红包将在10分钟内完成发放，请注意查看个人账户。</p>"),function(){}):showLayer(getLayerContent("additional_packet","<div class='additional_content'><div class='additional_cop_left clearfix'><p class='additional_title'>经销商红包</p><p class='money-line'><span class='money-icon'>￥</span>"+a.couponAmt/100+"</p><p class='additional_ad'>满"+a.effectiveAmt/100+"可用</p></div><div class='additional_cop_right clearfix'><p class='additional-title'>可用范围：</p><p class='additional_shop'>"+a.dealerCoupons[0].dealerName+"</p></div></div><p class='rob_my_tip'>恭喜您获得一张价值<span>"+a.couponAmt/100+"</span>元的红包！</p><p class='rob_my_time'> 红包将在10分钟内完成发放，请注意查看个人账户。</p>"),function(){}),t(o.remainTime),void(s=!1)}_paq.push(["trackEvent","mobile_lottery","rolled_prize_level_"+d.info.activityId,o.prizeLevel]),c(o.prizeLevel+"",i)})}function a(){s||(s=!0,_paq.push(["trackEvent","mobile_lottery","roll_click",d.info.activityId]),o())}function c(t,n){var e=d.AWARDS[t]||d.AWARDS[999],i=randomPick(e.deg);l(8e3,i,n)}function l(t,n,e){var i=360*Math.floor(r/360),n=n+i+1440;r=n,d.flashLight.restart(100),d.$avardBoard.animate({rotate:n+"deg"},t,"ease-out",function(){d.flashLight.restart(1e3),$.isFunction(e)&&e()})}{var s,r=-9.5,d={};d.AWARDS={"01":{name:"一等奖",deg:[315.5]},"02":{name:"二等奖",deg:[27.5]},"03":{name:"三等奖",deg:[99.5]},"04":{name:"四等奖",deg:[171.5]},"05":{name:"五等奖",deg:[243.5]},999:{name:"谢谢参与",deg:[-9.5,63.5,135.5,207.5,279.5,351.5]}}}return d.init=function(){function o(){l.on("click",".lottery-btn.active",a),l.on("click",".lottery-btn.disable-canshowrule",function(){$("#rule-lottery").click()}),l.on("click",".lottery-btn.nostart",function(){showLayer(getLayerContent("","活动未开始，请稍等 . . ."))}),l.on("click",".lottery-btn.isend",function(){showLayer(getLayerContent("","本轮活动已结束，下波活动敬请期待!"))}),l.on("click",".lottery-btn.disable-nochance",function(){showLayer(getLayerContent("noChance","<p>您未获得抽奖机会或已用完。下单越多，抽奖机会越多！ </p><p>（详见幸运轮盘详细规则）</p>"))})}function c(t){$.get("/router/activity/chance",{activityId:s.activityId,companyId:userInfo.companyId,t:Date.now()},function(n){t&&t(n.data.ticketStock)})}d.init=null;var l=(d.$avardBoard=$(".lottery-award"),d.$lottery=$(".lottery")),s=(d.$chanceLeft=$("#chance-left"),d.$lotteryBtn=l.find(".lottery-btn"),d.info=ACT_INFO.lottery);if(d.flashLight=i(),!s)return n("disable"),_paq.push(["trackEvent","mobile_lottery","enter_no_lottery"]),e(-1);if(s.startLeft<1&&e(-1),s.startLeft>0)n("disable nostart"),e(s.startLeft,function(){$("#lottery-time-bar").replaceWith('<div class="coming-soon">活动即将开始<br><a href="">点击刷新</a></div>'),_paq.push(["trackEvent","mobile_lottery","waited_start",s.activityId])}),_paq.push(["trackEvent","mobile_lottery","enter_not_start",s.activityId]);else if(s.endLeft>0&&s.startLeft<=0&&1==s.status)n("disable"),$("#lottery-time-bar").replaceWith('<div class="coming-soon">活动即将开始<br><a href="">点击刷新</a></div>');else{if(!(s.endLeft<1))return 1==s.status&&(n("disable nostart"),$("#lottery-time-bar").show(),$("#lottery-time-bar").replaceWith('<div class="coming-soon">活动即将开始<br><a href="">点击刷新</a></div>')),void c(function(e){t(e),parseInt(e)>0&&n("active"),o()});n("disable isend"),$(".lottery").find(".chance-left").text("本轮活动已结束"),_paq.push(["trackEvent","mobile_lottery","enter_end",s.activityId])}c(function(n){t(n)}),o()},d}();t.init()}function initCommon(){var t=$(".rule-panel"),n="/router/activity/award_list",e=.85*$(window).height();t.find(".content").find(".rules").height(e-180),t.find(".content").height(e),t.find(".close,.layer-cls-btn").click(function(){t.hide(),$("html").css("overflow-y","auto"),t.find(".rules").html("")}),$("#lucky-rule").click(function(){var n=.85*$(window).height();t.find(".content").find(".rules").height(n-180),t.find(".content").height(n),t.find(".content").removeClass("content-nodecre"),t.find(".content").removeClass("mouth-nodecre"),showRule("每日随机抢",luckyRuleHTML)}),$("#lucky-winning").click(function(){if(t.find(".content").height(346),t.find(".content").find(".rules").height(225),t.find(".content").addClass("content-nodecre"),t.find(".content").removeClass("mouth-nodecre"),showRule("抢红包中奖公布",winningList),"undefined"!=typeof luckData)addWinningList(t.find(".content").find(".list-wrap"),luckData);else{if(!ACT_INFO.lucky.pre.activityId)return;$.get(n,{activityId:ACT_INFO.lucky.pre.activityId,activityType:ACT_INFO.lucky.pre.activityTypeId,t:Date.now()},function(n){var n=JSON.parse(n);n.status||(luckData=n.data,addWinningList(t.find(".content").find(".list-wrap"),luckData))})}}),$("#lottery-winning").click(function(){if(t.find(".content").height(346),t.find(".content").find(".rules").height(225),t.find(".content").addClass("content-nodecre"),t.find(".content").removeClass("mouth-nodecre"),showRule("幸运轮盘中奖公布",winningList),"undefined"!=typeof lotteryData)addWinningList(t.find(".content").find(".list-wrap"),lotteryData);else{if(!ACT_INFO.lottery.activityId)return;$.get(n,{activityId:ACT_INFO.lottery.activityId,activityType:ACT_INFO.lottery.activityTypeId,t:Date.now()},function(n){var n=JSON.parse(n);n.status||(lotteryData=n.data,addWinningList(t.find(".content").find(".list-wrap"),lotteryData))})}}),$("#mouth-winning").click(function(){var n=.85*$(window).height();t.find(".content").find(".rules").height(n-155),t.find(".content").height(n),t.find(".content").removeClass("content-nodecre"),t.find(".content").addClass("mouth-nodecre"),showRule("TOP排行中奖公布",monthWinList)}),$("#lottery-rule").click(function(){var n=.85*$(window).height();t.find(".content").find(".rules").height(n-180),t.find(".content").height(n),t.find(".content").removeClass("content-nodecre"),t.find(".content").removeClass("mouth-nodecre"),showRule("幸运轮盘每周抽",lotteryRuleHTML)}),$("#month-rule").click(function(){var n=.85*$(window).height();t.find(".content").find(".rules").height(n-180),t.find(".content").height(n),t.find(".content").removeClass("content-nodecre"),t.find(".content").removeClass("mouth-nodecre"),showRule("赢TOP排行",monthRuleHTML)}),$("#reg-rule").click(function(){var n=.85*$(window).height();t.find(".content").find(".rules").height(n-180),t.find(".content").height(n),t.find(".content").removeClass("content-nodecre"),t.find(".content").removeClass("mouth-nodecre"),showRule("注册红包立即送",regRuleHTML)})}function showRule(t,n){var e=$(".rule-panel");e.find(".rules").html(n),e.find(".title").html(t),$("html").css("overflow","hidden"),e.show()}function addWinningList(t,n){var e=t.find(".list"),t=jQuery((t||$(document.body))[0]),i=i||n,o="";$.each(i,function(t,n){var e=n.name||"**********",i=n.tel||"**********",a=n.couponAmt/100;o+='<div class="row'+(t%2==1?" even":"")+'"><div class="col">'+e.substr(0,2)+"*****"+e.substr(-1,1)+'</div><div class="col">'+i.substr(0,3)+"****"+i.substr(-1,4)+'</div><div class="col">'+a+"元红包</div></div>"}),e.html(o),i.length>6&&t.scrollbox({autoPlay:!0,linear:!0,distance:30,step:1,delay:0,speed:50,listElement:".list",listItemElement:".row"})}function showLayer(t,n){layer.open({type:1,title:!1,closeBtn:0,shadeClose:!1,shade:[.5,"#000"],scrollbar:!1,content:t,success:function(t,e){t.css({background:"none","box-shadow":"none"}),n&&n(t,e),t.find(".close").click(function(){layer.close(e)})}})}function getLayerContent(t,n,e,i){var t=t||"",o='<a href="javascript:void()" class="close">确     认</a>',i=i||"";e&&(o="");var a='<div class="layer-noprize '+t+'">'+i+'<div class="layer-tips">'+n+"</div>"+o+"</div>";return a}var rollTime=5;!function(){window.layer={open:function(t){var n=$('<div class="shadowMask"></div>'),e=$('<div class="wrap"></div>');e.html(t.content),n.append(e),$(document.body).append(n),n.show(),t.success(e,1),$("html").css("overflow","hidden")},close:function(){$(".shadowMask").remove(),$("html").css("overflow","auto")},alert:function(t){alert(t)}},monthWinList="";var t=ACT_INFO.winningList;return t.content?(monthWinList="<dl>",t.title&&(monthWinList=monthWinList+"<p class='tac'><b>"+t.title+"</b></p>"),monthWinList=monthWinList+t.content+"</dl>",luckyRuleHTML+="<p>9)  奖励由本公司提供，与苹果官方无关；</p>",regRuleHTML+="<p>8)  奖励由本公司提供，与苹果官方无关；</p>",lotteryRuleHTML+="<p>11)  奖励由本公司提供，与苹果官方无关；</p>",void(monthRuleHTML+="<p>9)  奖励由本公司提供，与苹果官方无关；</p>")):void(monthWinList=t.default||"敬请期待！")}(),$(function(){initLucky(),initLottery(),initCommon()});